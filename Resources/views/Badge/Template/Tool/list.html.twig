{# this is the mes evaluations block #}
{% if pageContext is defined and pageContext == 'my_evals' %}
    {% set atLeastOne = false %}
    {% for workspaceBadge in badgePager %}
        {% if workspaceBadge.type == 'inprogress' %}
            {% set badge = workspaceBadge.badge %}
            {% set buttonLink = workspaceBadge.associatedResourceUrl %}
            {# local variables #}
            {% set isOver = false %}
            {% set isNotStarted = false %}
            {% set userResult = false %}
            {# check eval status #}
            {% if workspaceBadge.associatedResource.dropzone.getEndReview() < date() %}
                {% set isOver = true %}
            {% endif %}
            {% if workspaceBadge.associatedResource.dropzone.isNotStarted() %}
                {% set isNotStarted = true %}
            {% endif %}
            {# check user eval status #}
            {% if workspaceBadge.associatedResource.drop is defined %}
                {% if workspaceBadge.associatedResource.drop.calculatedGrade is defined and workspaceBadge.associatedResource.drop.countFinishedCorrections >= workspaceBadge.associatedResource.dropzone.expectedTotalCorrection %}
                    {% if workspaceBadge.associatedResource.drop.calculatedGrade >= workspaceBadge.associatedResource.dropzone.minimumScoreToPass %}
                        {% set userResult = 'succeed' %}
                    {% else %}
                        {% set userResult = 'failed' %}
                    {% endif %}
                {% endif %}
            {% endif %}
            
            <li class="slrn-my_badges-list__item">
                <img src="{{ image(badge.webPath).zoomCrop(100,100) }}" 
                     alt="{{ badge.name }}" 
                     class="slrn-my_badges-list__item__image"
                     width="100"
                     height="100"
                >
                <section class="slrn-my_badges-list__body">
                    <h6 class="slrn-my_badges-list__item__title slrn-my_badges-list__item__title--my_evals">Badge &laquo; {{ badge.name }} &raquo;</h6>
                    <div class="slrn-my_badges-list__content slrn-my_badges-list__content--my_evals">
                        {{'start_date'|trans({}, 'solerni')}} : {{ workspaceBadge.associatedResource.dropzone.getStartAllowDrop()|date('d/m/y') }}
                    </div>
                    <footer class="slrn-my_badges-list__footer">
                         {% if userResult == 'succeed' %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalSucceed'|trans({}, 'solerni')}}
                            </a>
                        {% elseif userResult == 'failed' %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalFailed'|trans({}, 'solerni')}}
                            </a>
                        {% elseif isOver == true %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalOver'|trans({}, 'solerni')}}
                            </a>
                        {% elseif isNotStarted == true %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalNotStarted'|trans({}, 'solerni')}}
                            </a>
                        {% elseif buttonLink %}
                            <a class="btn btn-primary pull-right" href="{{ buttonLink }}">
                                {{'continue_evaluation'|trans({}, 'solerni')}}
                            </a>
                        {% endif %}
                    </footer>
                </section>
            </li>
        {% endif %}
    {% endfor %}
{% else %}
    {# this is the badges de competences pages #}
    <ul class="panel-body my_badges slrn-my_badges-list">
        {% set badgesToGo = nbTotalBadges - nbAcquiredBadges %}
        <h5 class="slrn-bold slrn-my_badges_enumerate">Il vous reste encore {{ badgesToGo }} badge{% if badgesToGo > 1 %}s{% endif %} Ã  obtenir</h5>
        {% for workspaceBadge in badgePager %}
            {% set badgeType = workspaceBadge.type %}
            {% if 'owned' == badgeType %}
                    {% set badge     = workspaceBadge.badge.badge %}
                    {% set userBadge = workspaceBadge.badge %}
                    {% set buttonLink = path( 'claro_workspace_tool_view_my_badge', {'workspaceId': workspace.id, 'slug': badge.slug } ) %}
            {% else %}
                    {% set badge     = workspaceBadge.badge %}
                    {% if workspaceBadge.associatedResourceUrl is defined %}
                        {% set buttonLink =  workspaceBadge.associatedResourceUrl %}
                    {% endif %}
            {% endif %}
            {# local variables #}
            {% set atLeastOne = true %}
            {% set isOver = false %}
            {% set isNotStarted = false %}
            {% set userResult = false %}
            {# check eval status #}
            {% if workspaceBadge.associatedResource.dropzone.getEndReview() < date() %}
                {% set isOver = true %}
            {% endif %}
            {% if workspaceBadge.associatedResource.dropzone.isNotStarted() %}
                {% set isNotStarted = true %}
            {% endif %}
            {# check user eval status #}
            {% if workspaceBadge.associatedResource.drop is not null %}
                {% if workspaceBadge.associatedResource.drop.calculatedGrade is defined and workspaceBadge.associatedResource.drop.countFinishedCorrections >= workspaceBadge.associatedResource.dropzone.expectedTotalCorrection %}
                    {% if workspaceBadge.associatedResource.drop.calculatedGrade >= workspaceBadge.associatedResource.dropzone.minimumScoreToPass %}
                        {% set userResult = 'succeed' %}
                    {% else %}
                        {% set userResult = 'failed' %}
                    {% endif %}
                {% endif %}
            {% endif %}
        
            <li class="slrn-my_badges-list__item">
                <img src="{{ asset(badge.webPath) }}" alt="{{ badge.name }}" class="slrn-my_badges-list__item__image" />
                <section class="slrn-my_badges-list__body">
                    <h6 class="slrn-my_badges-list__item__title">Badge &laquo; {{ badge.name }} &raquo;</h6>
                    {% if 'owned' == badgeType %} 
                        <span class=" slrn-my_badges-list__body__status"><span class="slrn-bold">Obtenu le :</span> {{ userBadge.issuedAt|date('date_format'|trans({}, 'platform')) }}</span>
                    {% endif %}
                    {% if 'inprogress' == badgeType %}
                         <span class=" slrn-my_badges-list__body__status"><span class="slrn-bold">Badge en cours d'acquisition</span></span>
                    {% endif %}
                    <article class="slrn-my_badges-list__content">{{ badge.criteria | raw }}</article>
                    <footer class="slrn-my_badges-list__footer">
                        <span class="slrn-gratuit-icon">prix gratuit</span>
                         {% if 'owned' == badgeType %}
                            <a class="btn btn-primary pull-right" href="{{ buttonLink }}">
                                {{'my_badge_details'|trans({}, 'platform')}}
                            </a>
                         {% elseif userResult == 'succeed' %}
                            {{ workspaceBadge.associatedResource.drop.calculatedGrade }}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalSucceed'|trans({}, 'solerni')}}
                            </a>
                        {% elseif userResult == 'failed' %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalFailed'|trans({}, 'solerni')}}
                            </a>
                        {% elseif isOver == true %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalOver'|trans({}, 'solerni')}}
                            </a>
                        {% elseif isNotStarted == true %}
                            <a class="btn btn-gris pull-right" href="{{ buttonLink }}">
                                {{'evalNotStarted'|trans({}, 'solerni')}}
                            </a>
                        {% elseif buttonLink %}
                            <a class="btn btn-primary pull-right" href="{{ buttonLink }}">
                                {% if 'inprogress' == badgeType %} 
                                   {{'go_to_evaluation'|trans({}, 'platform')}}
                                {% endif %}
                                {% if 'available' == badgeType %} 
                                    {{'get_this_badge'|trans({}, 'platform')}}
                                {% endif %}
                            </a>
                        {% endif %}    
                    </footer>
                </section>
            </li>
            {#<li class="col-md-6">
                {% if 'owned' == badgeType %}
                    {% set badge     = workspaceBadge.badge.badge %}
                    {% set userBadge = workspaceBadge.badge %}
                    <div class="panel panel-default badge_panel owned_badge">
                        <div class="panel-heading">
                            <h3 class="panel-title">{{ badge.name }}<small class="pull-right"><span class="icon-ok"></span> {{ 'badge_awarded_on'|trans({'%awardingDate%': userBadge.issuedAt|date('date_format'|trans({}, 'platform'))}, 'badge') }}</small></h3>
                        </div>
                        <div class="panel-body">
                            <div class="col-md-4">
                                <img src="{{ asset(badge.webPath) }}" alt="{{ badge.name }}" class="badge_image_informations" />
                            </div>
                            <div class="col-md-8">
                                <p>{{ badge.description }}</p>
                                <p>
                                    <a href="{{ path('claro_workspace_tool_view_my_badge', {'workspaceId': workspace.id, 'slug': badge.slug}) }}" title="{{ 'consult_my_badge_details'|trans({}, 'badge') }}" class="btn btn-default" role="button">
                                        {{ 'consult_my_badge_details'|trans({}, 'badge') }}
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    {% set badge = workspaceBadge.badge %}
                    <div class="panel panel-default badge_panel">
                        <div class="panel-heading">
                            <h3 class="panel-title">{{ badge.name }}{% if 'inprogress' == badgeType %}<small class="pull-right">{{ 'badge_awarding_in_progress'|trans({}, 'badge') }}</small>{% endif %}</h3>
                        </div>
                        <div class="panel-body">
                            <div class="col-md-4">
                                <img src="{{ asset(badge.webPath) }}" alt="{{ badge.name }}" class="badge_image_informations" />
                            </div>
                            <div class="col-md-8">
                                <p>{{ badge.description }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </li>
        {% else %}
            <li class="node-thumbnail node">
                {{ 'no_badges_in_workspace'|trans({}, 'badge')|raw }}
            </li>#}
        {% endfor %}
    </ul>
{% endif %}
{% if badgePager.haveToPaginate %}
<div>
    {{
        pagerfanta(
            badgePager,
            'twitter_bootstrap_translated',
            {
                'proximity' :    1,
                'routeName':     'claro_workspace_tool_my_badges',
                'routeParams':   {'workspaceId': workspace.id},
                'pageParameter': '[badgePage]'
            }
        )
    }}
</div>
{% endif %}
